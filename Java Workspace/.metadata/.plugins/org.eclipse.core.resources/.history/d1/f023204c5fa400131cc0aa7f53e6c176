package Tweetmodelextractor;
import java.io.BufferedReader;
import java.io.BufferedWriter;
import java.io.FileNotFoundException;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;
import java.math.BigInteger;
import java.nio.charset.Charset;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.geonames.Toponym;
import org.geonames.ToponymSearchCriteria;
import org.geonames.ToponymSearchResult;
import org.geonames.WebService;

import twitter4j.*;
import twitter4j.auth.AccessToken;
import twitter4j.conf.ConfigurationBuilder;
import uk.ac.shef.wit.simmetrics.similaritymetrics.CosineSimilarity;


import com.csvreader.CsvReader;



public class modelextractor {
	
	

	
	private static ConfigurationBuilder configBuilder;
	private final static String CONSUMER_KEY = "LnGrwVvqBr0LxnHc5OsMRA";
    private final static String CONSUMER_KEY_SECRET =     "hn4CDER2MErFY94ZvgVAWHpAriuJTnXvQyxR6gzXCJ8";
	

	
	static String[] event2files = {"F:/tweetdata/gaga.csv"} ;
	
	
	static HashMap<String,Integer> ids= new HashMap<String,Integer>();
	static Map<String,Integer> keywordscount= new HashMap<String,Integer>();
	static CsvReader products;
	static String tweetScreenName;
	static ArrayList<City> allcities;
	static HashMap<String,String> stopwordshm = new HashMap<String,String>();
	public static void main(String[] args) {
	//CosineSimilarity  cs = new CosineSimilarity();
	//System.out.println(cs.getSimilarity("Banane schmeckt super und ist toll", "Banane ist ganz gut aber schmeckt toll"));
	
		
		
	
	startReading(); 
		//checkTwitter();
	}

public static void checkTwitter()
{
	
	configBuilder = new ConfigurationBuilder();
    configBuilder.setDebugEnabled(true);        
    configBuilder.setOAuthConsumerKey("LnGrwVvqBr0LxnHc5OsMRA");
    configBuilder.setOAuthConsumerSecret("hn4CDER2MErFY94ZvgVAWHpAriuJTnXvQyxR6gzXCJ8");
    configBuilder.setOAuthAccessToken("26801165-5i0EGcmO1uu64q8RQzVROfgM2VmIhJOVkIR5CI6JV");
    configBuilder.setOAuthAccessTokenSecret("JxGX8D64myzHFM7K5YufwYucK6EEcc6kKbVranA0F4");
    
	
	 try {
        
		 
	
         Twitter twitter = new TwitterFactory(configBuilder.build()).getInstance();
    	 /*User user = twitter.showUser("Dan_Miller");
    
         System.out.println("Showing @" + user.getDescription() + "'s home timeline.");*/
      
         int idCount = 0;
 		ArrayList<TweetModel> alltweets= new ArrayList<TweetModel>();
 		for (int t=0; t<event2files.length; t++)
 		{
 		
 		try {
 		
 			products = new CsvReader(event2files[t],'\t');
 		
 			products.readHeaders();
 		for ( int i = 0; i<products.getHeaders().length;i++)
 			{
 			//System.out.println(products.getHeaders()[i]);
 			}
 			
 	
 			
 		BufferedWriter writer = null;
 		try
 		{
 		    writer = new BufferedWriter( new FileWriter("F://users.txt"));
 		   
 		  
 		}
 		catch ( IOException e)
 		{
 		}
 				while (products.readRecord())
 				{
 					
 					//Tweetdetails
 					String creationDate = products.get("TWEET_CREATIONDATE");
 					String tweetContent = products.get("TWEET_CONTENT");
 					String tweetreplytostatus = products.get("TWEET_REPLYTOSTATUS");
 					String tweetreplytousername = products.get("TWEET_REPLYTOUSERNAME");
 					String tweetreplytouserid = products.get("TWEET_REPLYTOUSERID");
 					String tweetplace = products.get("TWEET_PLACE");
 					String tweetfavourited = products.get("TWEET_FAVORITED");
 					
 				
 					
 					
 					tweetContent = tweetContent.replace("\\", "\\\\"); 
 					tweetContent = tweetContent.replace("'", " "); 
 					String keywordtemp = tweetContent;
 					String tweetUser = products.get("USER_NAME");
 					tweetUser = tweetUser.replace("'", " "); 
 					tweetScreenName = products.get("USER_SCREENNAME");
 					String coordinates = products.get("TWEET_COORDS");
 					
 					
 					
 					
 					
 					
 					// Userdetails
 					String Userstatusescount = products.get("USER_STATUSESCOUNT");
 					String UserFollowers = products.get("USER_FOLLOWERSCOUNT");
 					String UserLocation = products.get("USER_LOCATION");
 					String UserFriendscount = products.get("USER_FRIENDSCOUNT");
 					String UserCreationDate = products.get("USER_CREATIONDATE");
 					String UserDescription = products.get("USER_DESCRIPTION");
 					String UserListedCount = products.get("USER_LISTEDCOUNT");
 					String tweetID = products.get("TWEET_ID");
 					String language = products.get("USER_LANGUAGE");
 					
 					
 					UserModel tempmodel= new UserModel();
 					if( coordinates==null || coordinates.contains("null") || coordinates=="" || coordinates.split(",").length<2)
 					{
 				
 					continue;

 					}
 					if(!ids.containsKey(tweetID))
 					{
 						
 						 User user = twitter.showUser(tweetScreenName.replace(" ", "_"));
 						 tempmodel = new UserModel(user.getCreatedAt(),user.getDescription(),user.getLang(),user.getListedCount(),user.getProfileImageURL(),user.isVerified(),user.isProtected(),user.getName(),user.getURL(),user.getId());
 						
 						
 					
 				
 					try
 					{
 						if(tempmodel.id==0)
 					    writer.append("INSERT INTO users (creationDate,description,language,userName,userURL,listedCount,isProtected,isVerified,profileImage,userID,userCreationdate) VALUES  ("+"\'"+tempmodel.creationDate +"\'"+","+"\'"+tempmodel.Description+"\'"+","+"\'"+tempmodel.language+"\'"+","+"\'"+tempmodel.userName+"\'"+","+"\'"+tempmodel.userURL+"\'" +","+tempmodel.listedCount +","+tempmodel.isProtected +"," + tempmodel.isVerified  +","+"\'"+ tempmodel.profileimage+"\'"  + ","+ tempmodel.id +");\n");

 					}
 					catch ( IOException e)
 					{
 					}
 					}
 					ids.put(tweetID,0);
 					
 					
 					
 					
 					
 					
 					
 				
 				}
 				
 		
 			    try
 			    {
 			        if ( writer != null)
 			        writer.close( );
 			    }
 			    catch ( IOException e)
 			    {
 			    }
 			products.close();
 			
 		} catch (FileNotFoundException e) {
 			e.printStackTrace();
 		} catch (IOException e) {
 			e.printStackTrace();
 		}
 	
 	}
 		System.out.println(idCount);
 	
         
         
         
         
         
         
     } catch (TwitterException te) {
         te.printStackTrace();
         System.out.println("Failed to get timeline: " + te.getMessage());
         System.out.println(tweetScreenName);
         products.close();
         //WriteXMLFile.writeXML(alltweets);
        // System.exit(-1);
     }
}
	
	
public static void startReading ()
	{
		int idCount = 0;
		ArrayList<TweetModel> alltweets= new ArrayList<TweetModel>();
		SentimentClassifier sentClassifier; 		
		sentClassifier = new SentimentClassifier(); 
		
		
		 
		for (int t=0; t<event2files.length; t++)
		{
		
		try {
		
			CsvReader products = new CsvReader(event2files[t],'\t');
			CsvReader cities = new CsvReader("C://Users/Lehle/Desktop/twitterprojekt/Credibility Tool/cities1000.txt", '\t');
		
			products.readHeaders();
			
			
		for ( int i = 0; i<products.getHeaders().length;i++)
			{
			//System.out.println(products.getHeaders()[i]);
			}
			
		try
			{
			BufferedReader textIn = new BufferedReader(new FileReader("F://stopwords.txt"));
	        String curLine = null;
	       
	  
	        while ((curLine = textIn.readLine()) != null) {
	            curLine = curLine.trim();
	         stopwordshm.put(curLine, curLine);
	         
	        }

			}
			catch (Exception e)
			{
			
			}
			
		BufferedWriter writer = null;
		try
		{
		    writer = new BufferedWriter( new FileWriter("F://newgaga.sql"));
		   
		    		

		}
		catch ( IOException e)
		{
		
		}
		allcities = new ArrayList<City>();
		while (cities.readRecord())
		{
		allcities.add(new City(cities.get(1),cities.get(4),cities.get(5),cities.get(14)));
		}
		System.out.println(allcities.size());
		
		//writer.append("USER_CREATIONDATE\tTWEETCONTENT\tTWEETUSER\tTWEETSCREENNAME\tLATITUDE\tLONGITUDE\tUSERSTATUSCOUNT\tUSERFOLLOWERS\tUSERFRIENDSCOUNT\tTWEETID\tLANGUAGE\tPLACE\tRETWEETCOUNT\tREPLYTOSTATUS\tREPLYTOUSERNAME\tCONTAINSURL\tAUTHORDESCRIPTION\tUSERLISTEDCOUNT\tUSERCREATIONDATE\tKEYWORDS\tSENTIMENT\n");
				while (products.readRecord())
				{
					//Tweetdetails
 					String creationDate = products.get("TWEET_CREATIONDATE");
 					String tweetContent = products.get("TWEET_CONTENT");
 					String tweetreplytostatus = products.get("TWEET_REPLYTOSTATUS");
 					String tweetreplytousername = products.get("TWEET_REPLYTOUSERNAME");
 					String tweetreplytouserid = products.get("TWEET_REPLYTOUSERID");
 					String tweetplace = products.get("TWEET_PLACE");
 					String tweetfavourited = products.get("TWEET_FAVORITED");
 					String tweetretweetcount = products.get("TWEET_RETWEETCOUNT");
 					tweetplace = tweetplace.replace("'", " "); 
 					int sentiment = 1;
 					String sent = sentClassifier.classify(tweetContent); 
 					/*if( tweetContent.contains("marathon")==false)
					{
				
					continue;

					}*/
 					
 					if( sent.contains("pos"))
 					{
 						sentiment = 1;
 					}
 					if( sent.contains("neg"))
 					{
 						sentiment = -1;
 						//System.out.println(tweetContent);
 					}
 					if( sent.contains("neu"))
 					{
 						sentiment = 0;
 					}
 					//System.out.println("Sentiment: " + sentiment);
 					tweetContent = tweetContent.replace("\\", "\\\\"); 
 					tweetContent = tweetContent.replace("'", ""); 
 					String tweetUser = products.get("USER_NAME");
 					tweetUser = tweetUser.replace("'", " "); 
 					tweetScreenName = products.get("USER_SCREENNAME");
 					String coordinates = products.get("TWEET_COORDS");
 					String keywordtemp= tweetContent;
 					
 					String[] keywordsplit = keywordtemp.split(" ");
 					
 					for ( int i=0; i< keywordsplit.length; i++)
 					{
 					if(stopwordshm.containsKey(keywordsplit[i]))
 					{
 						keywordtemp= keywordtemp.replaceAll(keywordsplit[i],"");
 						//System.out.println(keywordsplit[i]);
 					}
 					if(keywordsplit[i].contains("http") || keywordsplit[i].length()<3)
 					{
 						keywordtemp= keywordtemp.replace(keywordsplit[i],"");
 					}
 					if(keywordsplit[i].length()<3 )
 					{
 						//System.out.println("AAAAAH" +keywordsplit[i]);
 						keywordtemp= keywordtemp.replace(keywordsplit[i],"");
 					}
 					
 					}
 					keywordtemp= keywordtemp.replaceAll("[-+^#!?,.()@ÂÃâÅï]*", "");
 					keywordtemp= keywordtemp.replaceAll("[^\\p{L}\\p{Nd}]"," ");
 				
 					keywordsplit = keywordtemp.split(" ");
 					
 					for ( int i=0; i< keywordsplit.length; i++)
 					{
 						if(keywordscount.containsKey(keywordsplit[i]))
 	 					{
 							keywordscount.put(keywordsplit[i],keywordscount.get(keywordsplit[i])+1);
 	 						//System.out.println(keywordsplit[i]);
 	 					}
 						else
 						{
 							keywordscount.put(keywordsplit[i], 0);
 						}
 					
 					}
 					
 					
 					
 					
 					// Userdetails
 					String Userstatusescount = products.get("USER_STATUSESCOUNT");
 					String UserFollowers = products.get("USER_FOLLOWERSCOUNT");
 					String UserLocation = products.get("USER_LOCATION");
 					String UserFriendscount = products.get("USER_FRIENDSCOUNT");
 					String UserCreationDate = products.get("USER_CREATIONDATE");
 					String UserDescription = products.get("USER_DESCRIPTION");
 					String UserListedCount = products.get("USER_LISTEDCOUNT");
 					String tweetID = products.get("TWEET_ID");
 					String language = products.get("USER_LANGUAGE");
 					
					//if( coordinates==null || coordinates.contains("null") || coordinates=="" || coordinates.split(",").length<2 || tweetContent.contains("marathon")==false)
					if( coordinates==null || coordinates.contains("null") || coordinates=="" || coordinates.split(",").length<2 )
					{
				
					continue;

					}
					if(!ids.containsKey(tweetID))
					{
					TweetModel tempmodel = new TweetModel(keywordtemp,creationDate,coordinates,tweetContent,tweetUser,
							tweetScreenName,UserFollowers,UserFriendscount,Userstatusescount,language,tweetID,tweetplace,tweetretweetcount,tweetreplytostatus,tweetreplytousername,UserDescription,UserCreationDate,UserListedCount);
					
					double distance = 1000000000;
 					City closestc=null;
					
					for ( City ci: allcities)
 					{
 					
 					double delta = getDistanceInMeters(tempmodel,ci);
 					//System.out.println(delta);
 					if(delta < distance)
 					{
 						closestc = ci;
 						distance = delta;
 					}
 					
 					
 					}
					//System.out.println("Closest city: "+ closestc.name +  " lat: " + closestc.lat + " long: "+ + closestc.longi + " tlat: " + tempmodel.latitude + " tlong: "+ tempmodel.longitude );
				
					try
					{
						//csv OUTPUT
						//writer.append(""+tempmodel.date +"\t"+tempmodel.Content+"\t"+tempmodel.Author+"\t"+tempmodel.screenname+"\t"+tempmodel.latitude +"\t"+tempmodel.longitude +"\t"+tempmodel.userstatscount +"\t" + tempmodel.followers +"\t"+ tempmodel.friendscount + "\t"+ tempmodel.id + "\t"+tempmodel.lang+ "\t"+tempmodel.tweetplace+ "\t"+tempmodel.tweetretweetcount+"\t"+tempmodel.tweetreplytostatus+"\t"+tempmodel.tweetreplytousername+ "\t"+tempmodel.containsurl+","+tempmodel.authordescription+"\t"+tempmodel.listedcount+ "\t"+tempmodel.userdate+ "t"+tempmodel.keywords+ "\t"+sentiment+"\n");

					    writer.append("INSERT IGNORE INTO tweets (creationDate,tweetContent,tweetUser,tweetScreenName,latitude,longitude,userStatusCount,userFollowers,userFriendscount,tweetID,language,place,retweetcount,replytostatus,replytousername,containsUrl,authordescription,userlistedcount,userCreationdate,keywords,ccityname, ccitylat,ccitylong,sentiment, datasetID) VALUES  ("+"\'"+tempmodel.date +"\'"+","+"\'"+tempmodel.Content+"\'"+","+"\'"+tempmodel.Author+"\'"+","+"\'"+tempmodel.screenname+"\'"+","+tempmodel.longitude +","+tempmodel.latitude +","+ "\'"+tempmodel.userstatscount +"\'"+"," + tempmodel.followers +","+ tempmodel.friendscount + ","+ tempmodel.id + ","+"\'"+tempmodel.lang+ "\'"+","+"\'"+tempmodel.tweetplace+ "\'"+","+tempmodel.tweetretweetcount+","+tempmodel.tweetreplytostatus+","+"\'"+tempmodel.tweetreplytousername+ "\'"+","+tempmodel.containsurl+","+tempmodel.authordescription+","+"\'"+tempmodel.listedcount+ "\'"+","+"\'"+tempmodel.userdate+ "\'"+","+"\'"+tempmodel.keywords+ "\'"+","+"\'"+getMysqlRealScapeString(closestc.name)+ "\'"+","+ closestc.lat+","+ closestc.longi+","+"\'"+sentiment+ "\',3);\n");
					   

						
					
					
					}
					catch ( IOException e)
					{
					}
					}
					ids.put(tweetID,0);
					
					
					
					
					
					
					
				
				}
				
		
			    try
			    {
			        if ( writer != null)
			        writer.close( );
			    }
			    catch ( IOException e)
			    {
			    }
			    
			    keywordscount = MapUtil.sortByValue( keywordscount );
					int counter = 0;
					for(Map.Entry<String, Integer> e : keywordscount.entrySet()){
						
						 // System.out.println(e.getKey() + " = " + e.getValue());
						  counter++;
						  if(counter==100)
							  break;
						
						}
			    
			products.close();
			
		} catch (FileNotFoundException e) {
			e.printStackTrace();
		} catch (IOException e) {
			e.printStackTrace();
		}
	
	}
		
	//System.out.println(idCount);
	}
	

public static  double getDistanceInMeters(TweetModel tm, City c)
{
	double tmlat = Math.toRadians(tm.latitude);
	double tmlong = Math.toRadians(tm.longitude);
	double clat = Math.toRadians(c.lat);
	double clong = Math.toRadians(c.longi);
	 float radiusOfEarth = 6371000;// Earth's radius in meters.
     double diffLatitude =  clat -tmlat;
     double diffLongitude = clong -  tmlong;
     double a = Math.sin(diffLatitude / 2) * Math.sin(diffLatitude / 2) +
         Math.cos(tmlat) * Math.cos(clat) *  Math.sin(diffLongitude / 2) * Math.sin(diffLongitude / 2);
      double dc = 2 * Math.asin(Math.sqrt(a));
     double distance = radiusOfEarth * dc;
     return distance;
	
}

public static String getMysqlRealScapeString(String str) {
String data = null;
if (str != null && str.length() > 0) {
str = str.replace("\\", "\\\\");
str = str.replace("'", "\\'");
str = str.replace("\0", "\\0");
str = str.replace("\n", "\\n");
str = str.replace("\r", "\\r");
str = str.replace("\"", "\\\"");
str = str.replace("\\x1a", "\\Z");
data = str;
}
return data;
}

	
		   




}
